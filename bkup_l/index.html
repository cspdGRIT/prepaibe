<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIBE-XX Smart Prep with Auto AI</title>
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: var(--gray-50);
        }

        .hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 3rem 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .exam-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            display: inline-block;
            margin: 1rem 0;
            font-weight: 600;
        }

        .ai-badge {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            display: inline-block;
            margin: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .topic-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: var(--primary-light);
        }

        .topic-number {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .topic-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            padding-right: 3rem;
        }

        .topic-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30,64,175,0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .flashcard-header {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-source-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .source-static {
            background: #dbeafe;
            color: #1e40af;
        }

        .source-ai {
            background: #fef3c7;
            color: #92400e;
        }

        .auto-gen-badge {
            background: #d1fae5;
            color: #065f46;
        }

        .flashcard-container {
            perspective: 1000px;
            margin: 2rem 0;
        }

        .flashcard {
            position: relative;
            width: 100%;
            min-height: 400px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            min-height: 400px;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .card-content {
            font-size: 1.4rem;
            line-height: 1.8;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .progress-bar {
            background: var(--gray-200);
            height: 8px;
            border-radius: 1rem;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            transition: width 0.3s;
        }

        .settings-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-top: 0.5rem;
        }

        .chat-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            font-size: 2rem;
            min-width: 50px;
        }

        .message-content {
            background: var(--gray-100);
            padding: 1rem;
            border-radius: 1rem;
            max-width: 70%;
        }

        .message.user .message-content {
            background: var(--primary);
            color: white;
        }

        .chat-input-area {
            padding: 1.5rem;
            border-top: 2px solid var(--gray-200);
            display: flex;
            gap: 1rem;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .loading {
            display: inline-flex;
            gap: 0.3rem;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .topics-grid {
                grid-template-columns: 1fr;
            }
            
            .flashcard-face {
                padding: 2rem;
            }
            
            .card-content {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="hero">
        <h1>üéì AIBE-XX Smart Prep</h1>
        <div class="exam-badge">All India Bar Examination</div>
        <div class="ai-badge">ü§ñ Auto AI Generation Enabled</div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchView('topics')">üìö Topics</div>
            <div class="nav-tab" onclick="switchView('flashcards')">üé¥ Flashcards</div>
            <div class="nav-tab" onclick="switchView('settings')">‚öôÔ∏è AI Settings</div>
            <div class="nav-tab" onclick="switchView('qa')">üí¨ AI Chat</div>
        </div>

        <!-- Topics View -->
        <div id="topicsView" class="view active">
            <div id="topicsGrid" class="topics-grid"></div>
        </div>

        <!-- Flashcards View -->
        <div id="flashcardsView" class="view">
            <div class="flashcard-header">
                <div>
                    <h2 id="currentTopicTitle"></h2>
                    <div id="cardProgress"></div>
                    <div id="cardSourceBadge" class="card-source-badge"></div>
                </div>
                <button class="btn btn-secondary" onclick="backToTopics()">‚Üê Back to Topics</button>
            </div>

            <div id="autoGenAlert" class="alert alert-info" style="display: none;">
                ü§ñ Auto-generating more flashcards in the background...
            </div>

            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-face flashcard-front">
                        <div class="card-content" id="questionText"></div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="card-content" id="answerText"></div>
                    </div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" onclick="prevCard()" id="prevBtn">‚Üê Previous</button>
                <button class="btn btn-primary" onclick="nextCard()" id="nextBtn">Next ‚Üí</button>
                <button class="btn btn-success" onclick="manualGenerate()" id="manualGenBtn">ü§ñ Generate 15 More</button>
            </div>
        </div>

        <!-- AI Settings View -->
        <div id="settingsView" class="view">
            <div class="settings-card">
                <h2>‚öôÔ∏è AI Configuration</h2>
                
                <div class="form-group">
                    <label>LLM Provider</label>
                    <select id="llmProvider" onchange="updateProviderSettings()">
                        <option value="groq">Groq (Free - Fast)</option>
                        <option value="openrouter">OpenRouter (Multiple Models)</option>
                        <option value="ollama">Ollama (Local - Free)</option>
                        <option value="custom">Custom OpenAI-Compatible</option>
                    </select>
                    <div class="help-text">Choose your preferred AI provider</div>
                </div>

                <div id="groqSettings">
                    <div class="form-group">
                        <label>Groq API Key</label>
                        <input type="password" id="groqApiKey" placeholder="gsk_...">
                        <div class="help-text">Get free API key from <a href="https://console.groq.com/keys" target="_blank">console.groq.com</a></div>
                    </div>
                </div>

                <div id="openrouterSettings" style="display: none;">
                    <div class="form-group">
                        <label>OpenRouter API Key</label>
                        <input type="password" id="openrouterApiKey" placeholder="sk-or-v1-...">
                        <div class="help-text">Get from <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai</a></div>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <select id="openrouterModel">
                            <option value="meta-llama/llama-3.1-8b-instruct:free">Llama 3.1 8B (Free)</option>
                            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Free)</option>
                            <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                        </select>
                    </div>
                </div>

                <div id="ollamaSettings" style="display: none;">
                    <div class="form-group">
                        <label>Ollama Base URL</label>
                        <input type="text" id="ollamaUrl" value="http://localhost:11434" placeholder="http://localhost:11434">
                        <div class="help-text">Default local Ollama endpoint</div>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <input type="text" id="ollamaModel" value="llama3.1" placeholder="llama3.1">
                        <div class="help-text">Install models with: ollama pull llama3.1</div>
                    </div>
                </div>

                <div id="customSettings" style="display: none;">
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="customUrl" placeholder="https://api.example.com/v1">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="customApiKey" placeholder="Your API key">
                    </div>
                    <div class="form-group">
                        <label>Model Name</label>
                        <input type="text" id="customModel" placeholder="gpt-3.5-turbo">
                    </div>
                </div>

                <div class="form-group">
                    <label>Generation Settings</label>
                    <div style="margin-bottom: 1rem;">
                        <label>Cards per batch:</label>
                        <input type="number" id="cardsPerBatch" value="15" min="5" max="30" style="width: 100px;">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoGenerate" checked>
                        <label>Auto-generate when reaching last 3 cards</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="minCardsEnabled" checked>
                        <label>Ensure minimum 15 cards per topic</label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                <button class="btn btn-secondary" onclick="testConnection()">üîç Test Connection</button>
            </div>

            <div class="alert alert-success" id="settingsSuccess" style="display: none;">
                ‚úÖ Settings saved successfully!
            </div>
        </div>

        <!-- AI Chat View -->
        <div id="qaView" class="view">
            <div class="settings-card" style="margin-bottom: 2rem;">
                <h3>üí° Ask AI about AIBE topics</h3>
                <p>Get instant explanations, case laws, and exam tips from AI.</p>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Ask about any legal topic..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DATA STRUCTURE ==========
        let syllabusData = { topics: [] };
        
        // Flashcards loaded from external JSON files
        const flashcardsData = {
            1: [
                { q: "What is a contract under Section 2(h) of the Indian Contract Act?", a: "An agreement enforceable by law. Section 2(h) defines contract as an agreement that creates legal obligations between parties." },
                { q: "What are the essential elements of a valid contract?", a: "1) Offer and Acceptance 2) Consideration 3) Capacity to contract 4) Free consent 5) Lawful object 6) Not expressly declared void" },
                { q: "Explain the doctrine of privity of contract.", a: "Only parties to a contract can sue or be sued on it. Third parties cannot enforce the contract even if made for their benefit (Dunlop v. Selfridge)." },
                { q: "What is consideration under Contract Act?", a: "Something in return (Section 2(d)). It is the price for the promise. Can be past, present, or future, but must be real and lawful." },
                { q: "What makes an agreement void?", a: "Void agreements include: agreements without consideration, restraint of marriage, restraint of trade, restraint of legal proceedings, uncertain agreements, and wagering agreements." }
            ],
            2: [
                { q: "What is the Preamble to Indian Constitution?", a: "It declares India as Sovereign, Socialist, Secular, Democratic Republic. It ensures Justice, Liberty, Equality, and Fraternity to all citizens." },
                { q: "What is Article 14?", a: "Right to Equality - The State shall not deny any person equality before law or equal protection of laws within India." },
                { q: "Explain separation of powers.", a: "Division of governmental powers among Legislature (makes laws), Executive (implements laws), and Judiciary (interprets laws) to prevent concentration of power." },
                { q: "What is Judicial Review?", a: "Power of courts to examine the constitutionality of legislative enactments and executive orders. Can declare them void if violating Constitution." }
            ],
            3: [
                { q: "What is mens rea?", a: "Guilty mind - the mental element of a crime. It refers to the intention or knowledge of wrongdoing that constitutes part of a crime." },
                { q: "Define murder under IPC Section 300.", a: "Culpable homicide is murder if: act done with intention of causing death, causing bodily injury likely to cause death, or sufficient to cause death in ordinary course." },
                { q: "What is the difference between cognizable and non-cognizable offenses?", a: "Cognizable: Police can arrest without warrant (serious crimes). Non-cognizable: Police need warrant to arrest (less serious offenses)." }
            ],
            4: [
                { q: "What is a tort?", a: "A civil wrong that causes harm or injury to another person, for which the law provides a remedy in the form of damages." },
                { q: "Explain vicarious liability.", a: "Liability imposed on one person for the wrongful acts of another, typically employer for employee's torts committed in course of employment." },
                { q: "What is negligence in tort law?", a: "Failure to exercise reasonable care, resulting in damage. Requires: duty of care, breach of duty, causation, and actual damage." }
            ],
            5: [
                { q: "What is Transfer of Property Act, 1882 about?", a: "Regulates transfer of property between living persons by act of parties. Covers sale, mortgage, lease, exchange, and gift of immovable property." },
                { q: "What is the doctrine of lis pendens?", a: "Pending litigation - Property under litigation cannot be transferred to affect the rights of parties in the suit (Section 52 TPA)." }
            ]
        };

        // ========== STATE MANAGEMENT ==========
        let currentTopicId = null;
        let currentCardIndex = 0;
        let allCards = [];
        let aiGeneratedCards = {};
        let chatHistory = [];
        let isGenerating = false;
        let autoGenTriggered = false;

        // Settings
        let config = {
            provider: 'groq',
            groqApiKey: '',
            openrouterApiKey: '',
            openrouterModel: 'meta-llama/llama-3.1-8b-instruct:free',
            ollamaUrl: 'http://localhost:11434',
            ollamaModel: 'llama3.1',
            customUrl: '',
            customApiKey: '',
            customModel: '',
            cardsPerBatch: 15,
            autoGenerate: true,
            minCardsEnabled: true
        };

        // ========== INITIALIZATION ==========
        window.onload = async function() {
            loadSettings();
            loadAICards();
            await loadTopicsFromJSON();
            renderTopics();
        };

        async function loadTopicsFromJSON() {
            try {
                // Try to load from data directory (for local usage)
                const response = await fetch('data/topics_index.json');
                if (response.ok) {
                    const data = await response.json();
                    syllabusData = data;
                    
                    // Load flashcards for each topic
                    for (const topic of syllabusData.topics) {
                        await loadTopicFlashcards(topic.id, topic.file);
                    }
                    
                    console.log('‚úÖ Loaded topics from JSON files');
                    return;
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Could not load external JSON, using defaults:', e.message);
            }
            
            // Fallback to default topics if JSON loading fails
            syllabusData = {
                topics: [
                    { id: 1, title: "Contract Law", subtitle: "Indian Contract Act, 1872", file: "contract_law.json" },
                    { id: 2, title: "Constitutional Law", subtitle: "Indian Constitution", file: "constitutional_law.json" },
                    { id: 3, title: "Criminal Law", subtitle: "IPC, CrPC, Evidence Act", file: "criminal_law.json" },
                    { id: 4, title: "Torts", subtitle: "Law of Torts", file: "torts.json" },
                    { id: 5, title: "Property Law", subtitle: "Transfer of Property Act", file: "property_law.json" },
                    { id: 8, title: "Professional Ethics", subtitle: "Advocates Act, BCI Rules", file: "professional_ethics.json" }
                ]
            };
            
            // Try to load individual files
            for (const topic of syllabusData.topics) {
                await loadTopicFlashcards(topic.id, topic.file);
            }
        }

        async function loadTopicFlashcards(topicId, filename) {
            try {
                const response = await fetch(`data/${filename}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.flashcards && data.flashcards.length > 0) {
                        flashcardsData[topicId] = data.flashcards;
                        console.log(`‚úÖ Loaded ${data.flashcards.length} cards for topic ${topicId}`);
                    }
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è Could not load ${filename}:`, e.message);
                // Keep existing hardcoded cards as fallback
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem('aibe_ai_config');
            if (saved) {
                config = { ...config, ...JSON.parse(saved) };
                applySettings();
            }
        }

        function applySettings() {
            document.getElementById('llmProvider').value = config.provider;
            document.getElementById('groqApiKey').value = config.groqApiKey || '';
            document.getElementById('openrouterApiKey').value = config.openrouterApiKey || '';
            document.getElementById('openrouterModel').value = config.openrouterModel;
            document.getElementById('ollamaUrl').value = config.ollamaUrl;
            document.getElementById('ollamaModel').value = config.ollamaModel;
            document.getElementById('customUrl').value = config.customUrl || '';
            document.getElementById('customApiKey').value = config.customApiKey || '';
            document.getElementById('customModel').value = config.customModel || '';
            document.getElementById('cardsPerBatch').value = config.cardsPerBatch;
            document.getElementById('autoGenerate').checked = config.autoGenerate;
            document.getElementById('minCardsEnabled').checked = config.minCardsEnabled;
            updateProviderSettings();
        }

        function updateProviderSettings() {
            const provider = document.getElementById('llmProvider').value;
            document.getElementById('groqSettings').style.display = provider === 'groq' ? 'block' : 'none';
            document.getElementById('openrouterSettings').style.display = provider === 'openrouter' ? 'block' : 'none';
            document.getElementById('ollamaSettings').style.display = provider === 'ollama' ? 'block' : 'none';
            document.getElementById('customSettings').style.display = provider === 'custom' ? 'block' : 'none';
        }

        function saveSettings() {
            config = {
                provider: document.getElementById('llmProvider').value,
                groqApiKey: document.getElementById('groqApiKey').value.trim(),
                openrouterApiKey: document.getElementById('openrouterApiKey').value.trim(),
                openrouterModel: document.getElementById('openrouterModel').value,
                ollamaUrl: document.getElementById('ollamaUrl').value.trim(),
                ollamaModel: document.getElementById('ollamaModel').value.trim(),
                customUrl: document.getElementById('customUrl').value.trim(),
                customApiKey: document.getElementById('customApiKey').value.trim(),
                customModel: document.getElementById('customModel').value.trim(),
                cardsPerBatch: parseInt(document.getElementById('cardsPerBatch').value),
                autoGenerate: document.getElementById('autoGenerate').checked,
                minCardsEnabled: document.getElementById('minCardsEnabled').checked
            };
            
            localStorage.setItem('aibe_ai_config', JSON.stringify(config));
            
            const successMsg = document.getElementById('settingsSuccess');
            successMsg.style.display = 'block';
            setTimeout(() => successMsg.style.display = 'none', 3000);
        }

        async function testConnection() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'üîç Testing...';
            
            try {
                const testPrompt = "Reply with just 'OK' if you can read this.";
                const response = await callLLM(testPrompt);
                alert('‚úÖ Connection successful!\n\nResponse: ' + response.substring(0, 100));
            } catch (error) {
                alert('‚ùå Connection failed!\n\n' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Test Connection';
            }
        }

        // ========== LLM API CALLER ==========
        async function callLLM(userMessage, systemMessage = null) {
            const provider = config.provider;
            
            if (provider === 'groq') {
                if (!config.groqApiKey) throw new Error('Groq API key not configured');
                
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.groqApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-70b-versatile',
                        messages: [
                            ...(systemMessage ? [{ role: 'system', content: systemMessage }] : []),
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.8,
                        max_tokens: 4000
                    })
                });
                
                if (!response.ok) throw new Error('Groq API error: ' + response.statusText);
                const data = await response.json();
                return data.choices[0].message.content;
                
            } else if (provider === 'openrouter') {
                if (!config.openrouterApiKey) throw new Error('OpenRouter API key not configured');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.openrouterApiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AIBE Prep'
                    },
                    body: JSON.stringify({
                        model: config.openrouterModel,
                        messages: [
                            ...(systemMessage ? [{ role: 'system', content: systemMessage }] : []),
                            { role: 'user', content: userMessage }
                        ]
                    })
                });
                
                if (!response.ok) throw new Error('OpenRouter API error: ' + response.statusText);
                const data = await response.json();
                return data.choices[0].message.content;
                
            } else if (provider === 'ollama') {
                const response = await fetch(`${config.ollamaUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: config.ollamaModel,
                        messages: [
                            ...(systemMessage ? [{ role: 'system', content: systemMessage }] : []),
                            { role: 'user', content: userMessage }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) throw new Error('Ollama error: ' + response.statusText);
                const data = await response.json();
                return data.message.content;
                
            } else if (provider === 'custom') {
                if (!config.customUrl || !config.customApiKey) throw new Error('Custom API not configured');
                
                const response = await fetch(`${config.customUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.customApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.customModel,
                        messages: [
                            ...(systemMessage ? [{ role: 'system', content: systemMessage }] : []),
                            { role: 'user', content: userMessage }
                        ]
                    })
                });
                
                if (!response.ok) throw new Error('Custom API error: ' + response.statusText);
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            throw new Error('Invalid provider');
        }

        // ========== UI FUNCTIONS ==========
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function renderTopics() {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = syllabusData.topics.map(topic => {
                const staticCount = (flashcardsData[topic.id] || []).length;
                const aiCount = (aiGeneratedCards[topic.id] || []).length;
                const totalCount = staticCount + aiCount;
                
                return `
                    <div class="topic-card" onclick="startTopic(${topic.id})">
                        <div class="topic-number">${topic.id}</div>
                        <div class="topic-title">${topic.title}</div>
                        <div class="topic-subtitle">${topic.subtitle}</div>
                        <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-600);">
                            üìä ${totalCount} cards available
                            ${aiCount > 0 ? `<br>ü§ñ ${aiCount} AI-generated` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function startTopic(topicId) {
            currentTopicId = topicId;
            currentCardIndex = 0;
            autoGenTriggered = false;
            
            // Merge static and AI cards
            const staticCards = flashcardsData[topicId] || [];
            const aiCards = aiGeneratedCards[topicId] || [];
            allCards = [...staticCards, ...aiCards];
            
            // Check if we need to generate initial cards
            if (config.minCardsEnabled && allCards.length < 15) {
                await generateInitialCards();
            }
            
            const topic = syllabusData.topics.find(t => t.id === topicId);
            document.getElementById('currentTopicTitle').textContent = topic.title;
            
            displayCard();
            switchView('flashcards');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[1].classList.add('active');
        }

        async function generateInitialCards() {
            try {
                const needed = 15 - allCards.length;
                if (needed <= 0) return;
                
                document.getElementById('autoGenAlert').style.display = 'block';
                document.getElementById('autoGenAlert').innerHTML = `ü§ñ Generating ${needed} cards to reach minimum of 15...`;
                
                const newCards = await generateCards(needed);
                
                if (!aiGeneratedCards[currentTopicId]) {
                    aiGeneratedCards[currentTopicId] = [];
                }
                aiGeneratedCards[currentTopicId].push(...newCards);
                allCards = [...allCards, ...newCards];
                
                saveAICards();
                renderTopics();
                
                document.getElementById('autoGenAlert').innerHTML = `‚úÖ Generated ${newCards.length} cards successfully!`;
                setTimeout(() => {
                    document.getElementById('autoGenAlert').style.display = 'none';
                }, 3000);
            } catch (error) {
                document.getElementById('autoGenAlert').innerHTML = `‚ùå Auto-generation failed: ${error.message}`;
                setTimeout(() => {
                    document.getElementById('autoGenAlert').style.display = 'none';
                }, 5000);
            }
        }

        function displayCard() {
            if (allCards.length === 0) {
                document.getElementById('questionText').textContent = 'No cards available yet.';
                document.getElementById('answerText').textContent = 'Click "Generate More" to create flashcards!';
                return;
            }
            
            const card = allCards[currentCardIndex];
            document.getElementById('questionText').textContent = card.q;
            document.getElementById('answerText').textContent = card.a;
            
            // Update progress
            const progress = ((currentCardIndex + 1) / allCards.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('cardProgress').textContent = `Card ${currentCardIndex + 1} of ${allCards.length}`;
            
            // Update source badge
            const staticCount = (flashcardsData[currentTopicId] || []).length;
            const isAI = currentCardIndex >= staticCount;
            const badge = document.getElementById('cardSourceBadge');
            if (isAI) {
                badge.className = 'card-source-badge source-ai';
                badge.textContent = 'ü§ñ AI-Generated';
            } else {
                badge.className = 'card-source-badge source-static';
                badge.textContent = 'üìö Curated';
            }
            
            // Unflip card
            document.getElementById('flashcard').classList.remove('flipped');
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentCardIndex === 0;
            document.getElementById('nextBtn').disabled = false;
            
            // Auto-generate more cards if enabled and nearing end
            if (config.autoGenerate && !autoGenTriggered && !isGenerating) {
                const cardsRemaining = allCards.length - currentCardIndex;
                if (cardsRemaining <= 3) {
                    autoGenTriggered = true;
                    autoGenerateMore();
                }
            }
        }

        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function prevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                displayCard();
            }
        }

        function nextCard() {
            if (currentCardIndex < allCards.length - 1) {
                currentCardIndex++;
                displayCard();
            }
        }

        function backToTopics() {
            switchView('topics');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
        }

        // ========== AI GENERATION ==========
        async function generateCards(count = null) {
            const batchSize = count || config.cardsPerBatch;
            const topic = syllabusData.topics.find(t => t.id === currentTopicId);
            
            const systemPrompt = 'You are an expert in Indian law preparing AIBE exam questions. Generate high-quality flashcards in valid JSON format only.';
            
            const userPrompt = `Generate ${batchSize} high-quality AIBE exam flashcards for the topic: "${topic.title}" (${topic.subtitle}).

Requirements:
- Each card should have a clear Question (q) and detailed Answer (a)
- Focus on exam-relevant concepts, sections, case laws, and principles
- Answers should be comprehensive but concise (2-4 sentences)
- Cover different subtopics within ${topic.title}
- Include section numbers, legal principles, and practical examples
- Make questions progressively challenging
- Avoid duplicating existing questions

Format response as a JSON array:
[
  {"q": "Question 1?", "a": "Answer 1"},
  {"q": "Question 2?", "a": "Answer 2"}
]

Return ONLY the JSON array, no additional text or markdown formatting.`;

            const response = await callLLM(userPrompt, systemPrompt);
            let content = response.trim();
            
            // Extract JSON if wrapped in markdown
            if (content.includes('```json')) {
                content = content.replace(/```json\n?/g, '').replace(/```\n?$/g, '');
            } else if (content.includes('```')) {
                content = content.replace(/```\n?/g, '');
            }
            
            // Try to find JSON array in the response
            const jsonMatch = content.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                content = jsonMatch[0];
            }
            
            const newCards = JSON.parse(content);
            
            if (!Array.isArray(newCards) || newCards.length === 0) {
                throw new Error('Invalid response format');
            }
            
            return newCards;
        }

        async function autoGenerateMore() {
            if (isGenerating) return;
            
            isGenerating = true;
            document.getElementById('autoGenAlert').style.display = 'block';
            document.getElementById('autoGenAlert').innerHTML = 'ü§ñ Auto-generating more flashcards...';
            
            try {
                const newCards = await generateCards();
                
                if (!aiGeneratedCards[currentTopicId]) {
                    aiGeneratedCards[currentTopicId] = [];
                }
                aiGeneratedCards[currentTopicId].push(...newCards);
                allCards = [...allCards, ...newCards];
                
                saveAICards();
                renderTopics();
                displayCard();
                
                document.getElementById('autoGenAlert').innerHTML = `‚úÖ Generated ${newCards.length} new cards!`;
                setTimeout(() => {
                    document.getElementById('autoGenAlert').style.display = 'none';
                    autoGenTriggered = false;
                }, 3000);
            } catch (error) {
                document.getElementById('autoGenAlert').innerHTML = `‚ùå Auto-generation failed: ${error.message}`;
                setTimeout(() => {
                    document.getElementById('autoGenAlert').style.display = 'none';
                    autoGenTriggered = false;
                }, 5000);
            } finally {
                isGenerating = false;
            }
        }

        async function manualGenerate() {
            if (isGenerating) return;
            if (!config.groqApiKey && !config.openrouterApiKey && config.provider !== 'ollama') {
                alert('‚ö†Ô∏è Please configure your AI settings first!');
                switchView('settings');
                return;
            }
            
            const btn = document.getElementById('manualGenBtn');
            btn.disabled = true;
            isGenerating = true;
            btn.innerHTML = '<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div> Generating...';
            
            try {
                const newCards = await generateCards();
                
                if (!aiGeneratedCards[currentTopicId]) {
                    aiGeneratedCards[currentTopicId] = [];
                }
                aiGeneratedCards[currentTopicId].push(...newCards);
                allCards = [...allCards, ...newCards];
                
                saveAICards();
                renderTopics();
                displayCard();
                
                alert(`‚úÖ Successfully generated ${newCards.length} new cards!`);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}\n\nPlease check your settings and try again.`);
            } finally {
                btn.disabled = false;
                isGenerating = false;
                btn.innerHTML = `ü§ñ Generate ${config.cardsPerBatch} More`;
            }
        }

        // ========== AI CHAT ==========
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            
            if (!question) return;
            if (!config.groqApiKey && !config.openrouterApiKey && config.provider !== 'ollama') {
                alert('Please configure AI settings first!');
                switchView('settings');
                return;
            }
            
            addMessage('user', question);
            input.value = '';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
            
            try {
                const systemPrompt = 'You are an expert legal assistant helping students prepare for AIBE. Provide clear, accurate explanations with relevant sections and case laws.';
                const response = await callLLM(question, systemPrompt);
                addMessage('assistant', response);
            } catch (error) {
                addMessage('assistant', `‚ùå Error: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'üì§';
            }
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
            const label = role === 'user' ? 'You' : 'AI';
            
            // Format content with line breaks
            const formattedContent = content.replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content"><strong>${label}:</strong><br>${formattedContent}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            chatHistory.push({ role, content });
        }

        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ========== STORAGE ==========
        function saveAICards() {
            localStorage.setItem('aibe_ai_cards', JSON.stringify(aiGeneratedCards));
        }

        function loadAICards() {
            const saved = localStorage.getItem('aibe_ai_cards');
            if (saved) {
                aiGeneratedCards = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>
